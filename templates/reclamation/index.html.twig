{% extends 'base.html.twig' %}

{% block title %}Réclamations - Admin{% endblock %}

{% block body %}
    <div class="container-fluid">
        <div class="d-sm-flex align-items-center justify-content-between mb-4">
            <h1 class="h3 mb-0 text-gray-800">Gestion des Réclamations</h1>
            <div class="d-flex">
                <div class="btn-group mr-2">
                    <a href="{{ path('app_reclamation_export_pdf') }}{% if export_query %}?{{ export_query }}{% endif %}" class="btn btn-outline-primary" title="Export PDF"><i class="fas fa-file-pdf"></i></a>
                    <a href="{{ path('app_reclamation_export_csv') }}{% if export_query %}?{{ export_query }}{% endif %}" class="btn btn-outline-primary" title="Export CSV"><i class="fas fa-file-csv"></i></a>
                </div>
            </div>
        </div>

        {# Filters #}
        <div class="card shadow mb-4">
            <div class="card-header py-2">
                <button class="btn btn-link btn-sm p-0" type="button" data-toggle="collapse" data-target="#filterCollapse" aria-expanded="true" aria-controls="filterCollapse">
                    <i class="fas fa-filter"></i> Filtres
                </button>
            </div>
            <div class="collapse show" id="filterCollapse">
                <div class="card-body">
                    <form id="filter-form" class="form-inline flex-wrap gap-2 align-items-end">
                        <input type="hidden" name="per_page" value="{{ current_page_size }}">
                        <div class="form-group mb-2 mr-2">
                            <label class="sr-only" for="search">Recherche</label>
                            <input type="text" class="form-control form-control-sm" id="search" name="search" value="{{ filter_params.search }}" placeholder="Recherche (titre, description, nom, email...)">
                        </div>
                        <div class="form-group mb-2 mr-2">
                            <label class="sr-only" for="statut">Statut</label>
                            <select class="form-control form-control-sm" id="statut" name="statut">
                                <option value="">Tous les statuts</option>
                                <option value="en_attente" {{ filter_params.statut == 'en_attente' ? 'selected' : '' }}>En attente</option>
                                <option value="en_cours" {{ filter_params.statut == 'en_cours' ? 'selected' : '' }}>En cours</option>
                                <option value="resolue" {{ filter_params.statut == 'resolue' ? 'selected' : '' }}>Résolue</option>
                                <option value="cloturee" {{ filter_params.statut == 'cloturee' ? 'selected' : '' }}>Clôturée</option>
                            </select>
                        </div>
                        <div class="form-group mb-2 mr-2">
                            <label class="sr-only" for="priorite">Priorité</label>
                            <select class="form-control form-control-sm" id="priorite" name="priorite">
                                <option value="">Toutes</option>
                                <option value="basse" {{ filter_params.priorite == 'basse' ? 'selected' : '' }}>Basse</option>
                                <option value="moyenne" {{ filter_params.priorite == 'moyenne' ? 'selected' : '' }}>Moyenne</option>
                                <option value="haute" {{ filter_params.priorite == 'haute' ? 'selected' : '' }}>Haute</option>
                            </select>
                        </div>
                        <div class="form-group mb-2 mr-2">
                            <label class="sr-only" for="categorie">Catégorie</label>
                            <select class="form-control form-control-sm" id="categorie" name="categorie">
                                <option value="">Toutes catégories</option>
                                {% for cat in categories %}
                                    <option value="{{ cat|e('html_attr') }}" {{ filter_params.categorie == cat ? 'selected' : '' }}>{{ cat }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group mb-2 mr-2">
                            <label class="sr-only" for="date_from">Du</label>
                            <input type="date" class="form-control form-control-sm" id="date_from" name="date_from" value="{{ filter_params.date_from }}">
                        </div>
                        <div class="form-group mb-2 mr-2">
                            <label class="sr-only" for="date_to">Au</label>
                            <input type="date" class="form-control form-control-sm" id="date_to" name="date_to" value="{{ filter_params.date_to }}">
                        </div>
                        <div class="form-group mb-2">
                            <button type="submit" class="btn btn-primary btn-sm"><i class="fas fa-search"></i> Filtrer</button>
                            <a href="{{ path('app_reclamation_index') }}" class="btn btn-secondary btn-sm">Réinitialiser</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        {# Table #}
        <div class="card shadow mb-4">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover table-striped mb-0 admin-advanced-table">
                        <thead class="thead-light sticky-top bg-light">
                        <tr>
                            <th>ID</th>
                            <th>Sujet & Catégorie</th>
                            <th>Auteur</th>
                            <th>Date</th>
                            <th>Statut</th>
                            <th>Priorité</th>
                            <th class="text-center">Réponses</th>
                            <th class="text-right">Actions</th>
                        </tr>
                        </thead>
                        <tbody id="reclamation-table-body">
                        {% include 'reclamation/_table_rows.html.twig' with { pagination: pagination } %}
                        </tbody>
                    </table>
                </div>
                <div class="card-footer py-2" id="pagination-wrapper">
                    {% include 'reclamation/_pagination.html.twig' %}
                </div>
            </div>
        </div>
    </div>

    {% include 'parts/_modal_form.html.twig' %}
    {% include 'parts/_delete_confirm_modal.html.twig' %}
    {% include 'parts/_toast_container.html.twig' %}
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var listAjaxUrl = '{{ path('app_reclamation_list_ajax') }}';
            var tableBody = document.getElementById('reclamation-table-body');
            var paginationWrapper = document.getElementById('pagination-wrapper');
            var filterForm = document.getElementById('filter-form');
            var searchInput = document.getElementById('search');
            var perPageSelect = document.querySelector('.per-page-select');
            var debounceTimer;

            var loadList = function(queryString) {
                var url = listAjaxUrl;
                if (queryString) url += '?' + queryString;
                else if (filterForm) {
                    var fd = new FormData(filterForm);
                    if (perPageSelect && perPageSelect.value) {
                        fd.set('per_page', perPageSelect.value);
                    }
                    url += '?' + new URLSearchParams(fd).toString();
                }

                paginationWrapper.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary"></div></div>';

                fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                    .then(function(r) { return r.json(); })
                    .then(function(data) {
                        tableBody.innerHTML = data.rows;
                        paginationWrapper.innerHTML = data.pagination;
                        var newSelect = paginationWrapper.querySelector('.per-page-select');
                        if (newSelect) {
                            newSelect.value = perPageSelect ? perPageSelect.value : (new URLSearchParams(window.location.search).get('per_page') || '10');
                            newSelect.addEventListener('change', function() { filterForm && filterForm.submit(); });
                        }
                        bindRowActions();
                    })
                    .catch(function() { showToast('Erreur lors du chargement.', 'danger'); });
            };

            function bindRowActions() {
                // Row actions are now standard links
            }

            filterForm && filterForm.addEventListener('submit', function(e) {
                e.preventDefault();
                loadList();
            });

            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    clearTimeout(debounceTimer);
                    debounceTimer = setTimeout(function() { loadList(); }, 350);
                });
            }

            if (perPageSelect) {
                perPageSelect.addEventListener('change', function() {
                    var fd = new FormData(filterForm);
                    fd.set('per_page', this.value);
                    var params = new URLSearchParams(fd);
                    loadList(params.toString());
                });
            }

            document.getElementById('pagination-wrapper').addEventListener('click', function(e) {
                var a = e.target.closest('a');
                if (a && a.href && a.getAttribute('href').indexOf('/reclamation') !== -1 && a.getAttribute('href').indexOf('/list-ajax') === -1) {
                    e.preventDefault();
                    var u = new URL(a.href);
                    loadList(u.search.slice(1));
                }
            });

            bindRowActions();
        });
    </script>
{% endblock %}
