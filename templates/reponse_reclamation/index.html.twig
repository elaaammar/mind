{% extends 'base.html.twig' %}

{% block title %}Réponses - Admin{% endblock %}

{% block body %}
    <div class="container-fluid">
        <div class="d-sm-flex align-items-center justify-content-between mb-4">
            <h1 class="h3 mb-0 text-gray-800">Gestion des Réponses</h1>
            <div class="d-flex">
                <div class="btn-group mr-2">
                    <a href="{{ path('app_reponse_reclamation_export_pdf') }}{% if export_query %}?{{ export_query }}{% endif %}" class="btn btn-outline-primary" title="Export PDF"><i class="fas fa-file-pdf"></i></a>
                    <a href="{{ path('app_reponse_reclamation_export_csv') }}{% if export_query %}?{{ export_query }}{% endif %}" class="btn btn-outline-primary" title="Export CSV"><i class="fas fa-file-csv"></i></a>
                </div>
                <a href="{{ path('app_reponse_reclamation_new') }}" class="btn btn-primary shadow-sm">
                    <i class="fas fa-plus-circle"></i> Nouvelle Réponse
                </a>
            </div>
        </div>

        <div class="card shadow mb-4">
            <div class="card-header py-2">
                <button class="btn btn-link btn-sm p-0" type="button" data-toggle="collapse" data-target="#filterCollapseRR" aria-expanded="true" aria-controls="filterCollapseRR">
                    <i class="fas fa-filter"></i> Filtres
                </button>
            </div>
            <div class="collapse show" id="filterCollapseRR">
                <div class="card-body">
                    <form id="filter-form" class="form-inline flex-wrap align-items-end">
                        <input type="hidden" name="per_page" value="{{ current_page_size }}">

                        <div class="form-group mb-2 mr-2">
                            <label class="sr-only" for="search">Recherche</label>
                            <input type="text" class="form-control form-control-sm" id="search" name="search" value="{{ filter_params.search }}" placeholder="Recherche (contenu, nom, type, titre réclamation...)">
                        </div>

                        <div class="form-group mb-2 mr-2">
                            <label class="sr-only" for="reclamation_id">Réclamation</label>
                            <select class="form-control form-control-sm" id="reclamation_id" name="reclamation_id">
                                <option value="">Toutes les réclamations</option>
                                {% for r in reclamations %}
                                    <option value="{{ r.id }}" {{ filter_params.reclamation_id == r.id ? 'selected' : '' }}>#{{ r.id }} - {{ r.titre|u.truncate(40) }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="form-group mb-2 mr-2">
                            <label class="sr-only" for="auteur_type">Type auteur</label>
                            <input type="text" class="form-control form-control-sm" id="auteur_type" name="auteur_type" value="{{ filter_params.auteur_type }}" placeholder="Type auteur">
                        </div>

                        <div class="form-group mb-2 mr-2">
                            <label class="sr-only" for="date_from">Du</label>
                            <input type="date" class="form-control form-control-sm" id="date_from" name="date_from" value="{{ filter_params.date_from }}">
                        </div>
                        <div class="form-group mb-2 mr-2">
                            <label class="sr-only" for="date_to">Au</label>
                            <input type="date" class="form-control form-control-sm" id="date_to" name="date_to" value="{{ filter_params.date_to }}">
                        </div>

                        <div class="form-group mb-2">
                            <button type="submit" class="btn btn-primary btn-sm"><i class="fas fa-search"></i> Filtrer</button>
                            <a href="{{ path('app_reponse_reclamation_index') }}" class="btn btn-secondary btn-sm">Réinitialiser</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="card shadow mb-4">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover table-striped mb-0 admin-advanced-table">
                        <thead class="thead-light sticky-top bg-light">
                        <tr>
                            <th>ID</th>
                            <th>Réclamation</th>
                            <th>Aperçu Contenu</th>
                            <th>Auteur / Type</th>
                            <th>Date création</th>
                            <th class="text-right">Actions</th>
                        </tr>
                        </thead>
                        <tbody id="rr-table-body">
                        {% include 'reponse_reclamation/_table_rows.html.twig' with { pagination: pagination } %}
                        </tbody>
                    </table>
                </div>
                <div class="card-footer py-2" id="pagination-wrapper">
                    {% include 'reponse_reclamation/_pagination.html.twig' %}
                </div>
            </div>
        </div>
    </div>

    {% include 'parts/_modal_form.html.twig' %}
    {% include 'parts/_delete_confirm_modal.html.twig' %}
    {% include 'parts/_toast_container.html.twig' %}
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var listAjaxUrl = '{{ path('app_reponse_reclamation_list_ajax') }}';
            var tableBody = document.getElementById('rr-table-body');
            var paginationWrapper = document.getElementById('pagination-wrapper');
            var filterForm = document.getElementById('filter-form');
            var searchInput = document.getElementById('search');
            var perPageSelect = document.querySelector('.per-page-select');
            var debounceTimer;

            function loadList(queryString) {
                var url = listAjaxUrl;
                if (queryString) url += '?' + queryString;
                else if (filterForm) {
                    var fd = new FormData(filterForm);
                    if (perPageSelect && perPageSelect.value) {
                        fd.set('per_page', perPageSelect.value);
                    }
                    url += '?' + new URLSearchParams(fd).toString();
                }

                paginationWrapper.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary"></div></div>';

                fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                    .then(function(r) { return r.json(); })
                    .then(function(data) {
                        tableBody.innerHTML = data.rows;
                        paginationWrapper.innerHTML = data.pagination;
                        var newSelect = paginationWrapper.querySelector('.per-page-select');
                        if (newSelect) {
                            newSelect.value = perPageSelect ? perPageSelect.value : (new URLSearchParams(window.location.search).get('per_page') || '10');
                            newSelect.addEventListener('change', function() { filterForm && filterForm.submit(); });
                        }
                        bindRowActions();
                    })
                    .catch(function() { showToast('Erreur lors du chargement.', 'danger'); });
            }

            function bindRowActions() {
                // Row actions are now standard links
            }

            filterForm && filterForm.addEventListener('submit', function(e) {
                e.preventDefault();
                loadList();
            });

            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    clearTimeout(debounceTimer);
                    debounceTimer = setTimeout(function() { loadList(); }, 350);
                });
            }

            if (perPageSelect) {
                perPageSelect.addEventListener('change', function() {
                    var fd = new FormData(filterForm);
                    fd.set('per_page', this.value);
                    var params = new URLSearchParams(fd);
                    loadList(params.toString());
                });
            }

            document.getElementById('pagination-wrapper').addEventListener('click', function(e) {
                var a = e.target.closest('a');
                if (a && a.href && a.getAttribute('href').indexOf('/reponse/reclamation') !== -1 && a.getAttribute('href').indexOf('/list-ajax') === -1) {
                    e.preventDefault();
                    var u = new URL(a.href);
                    loadList(u.search.slice(1));
                }
            });

            bindRowActions();
        });
    </script>
{% endblock %}
