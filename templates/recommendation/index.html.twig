{% extends 'base.html.twig' %}

{% block title %}{{ 'ai.insights'|trans }}{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        /* ── Stats Cards ── */
        .stat-card { border-radius: 12px; transition: transform .2s, box-shadow .2s; }
        .stat-card:hover { transform: translateY(-4px); box-shadow: 0 8px 24px rgba(0,0,0,.12); }
        .stat-icon { width: 52px; height: 52px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.4rem; }

        /* ── Timeline ── */
        .timeline { position: relative; padding-left: 28px; }
        .timeline::before { content:''; position:absolute; left:12px; top:0; bottom:0; width:2px; background:#e3e6f0; }
        .timeline-item { position: relative; margin-bottom: 1.5rem; }
        .timeline-dot { position: absolute; left: -22px; top: 4px; width: 14px; height: 14px; border-radius: 50%; border: 2px solid #fff; box-shadow: 0 0 0 2px #4e73df; background: #4e73df; }
        .timeline-dot.applied { background: #1cc88a; box-shadow: 0 0 0 2px #1cc88a; }

        /* ── Applied toggle ── */
        .applied-badge { cursor:pointer; transition: background .2s; }

        /* ── Chatbot ── */
        #chatbot-wrapper { position: fixed; top:160px; right:30px; width:350px; z-index:1020; transition: all .3s ease; }
        #chatbot-wrapper.minimized { width:250px; top:100px; right:20px; }
        #chatbot-wrapper.minimized .card-body,
        #chatbot-wrapper.minimized .card-footer,
        #chatbot-wrapper.minimized #suggested-questions { display:none !important; }
        #chatbot-toggle { cursor:pointer; }

        /* ── Filter pills ── */
        .filter-pill { cursor:pointer; transition: all .15s; }
        .filter-pill.active { font-weight:700; }
    </style>
{% endblock %}

{% block body %}
<div class="container-fluid">

    {# Header / Hero Section centered #}
    <div class="row mb-5 justify-content-center">
        <div class="col-lg-10 text-center">
            <h1 class="display-4 font-weight-bold text-gray-900 mb-3">
                <i class="fas fa-brain text-primary mr-2"></i>Optimisations IA
            </h1>
            <p class="h5 text-muted mx-auto mb-4" style="max-width: 800px; line-height: 1.6;">
                Découvrez des recommandations pertinentes générées par notre intelligence artificielle pour transformer vos données d'audit en actions concrètes et améliorer vos performances opérationnelles.
            </p>
            
            <div class="d-flex justify-content-center gap-3 mb-5">
                <button type="button" class="btn btn-primary btn-lg rounded-pill px-5 shadow" data-toggle="modal" data-target="#recommendationModal">
                    <i class="fas fa-magic mr-2"></i>Générer de nouvelles idées
                </button>
            </div>

            <div class="row justify-content-center mt-5">
                <div class="col-md-3 mb-4">
                    <div class="card border-0 shadow-sm py-4" style="border-radius: 20px; border-bottom: 5px solid #4e73df !important;">
                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Total Recommandations</div>
                        <div class="h2 font-weight-bold text-gray-800 mb-0">{{ stats.total }}</div>
                    </div>
                </div>
                <div class="col-md-3 mb-4">
                    <div class="card border-0 shadow-sm py-4" style="border-radius: 20px; border-bottom: 5px solid #1cc88a !important;">
                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Actions Appliquées</div>
                        <div class="h2 font-weight-bold text-gray-800 mb-0">{{ stats.applied }}</div>
                    </div>
                </div>
                <div class="col-md-3 mb-4">
                    <div class="card border-0 shadow-sm py-4" style="border-radius: 20px; border-bottom: 5px solid #f6c23e !important;">
                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">En attente</div>
                        <div class="h2 font-weight-bold text-gray-800 mb-0">{{ stats.pending }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <div class="row justify-content-center">
        {# ── CENTER: Timeline + List ── #}
        <div class="col-lg-10">

            {# Filters bar #}
            <div class="card shadow-sm mb-4 border-0" style="border-radius: 15px; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px);">
                <div class="card-body py-3">
                    <form id="recommendation-filter-form" method="get" class="d-flex flex-wrap gap-3 align-items-center justify-content-center">
                        <div class="d-flex align-items-center bg-light px-3 py-2 rounded-pill">
                            <i class="fas fa-file-alt text-primary mr-2"></i>
                            <select name="report" class="form-control form-control-sm border-0 bg-transparent" style="min-width:180px;">
                                <option value="">Tous les rapports</option>
                                {% for r in reports %}
                                    <option value="{{ r.id }}" {{ app.request.query.get('report') == r.id ? 'selected' : '' }}>{{ r.title|slice(0,30) }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="d-flex align-items-center bg-light px-3 py-2 rounded-pill">
                            <i class="fas fa-tasks text-success mr-2"></i>
                            <select name="status" class="form-control form-control-sm border-0 bg-transparent" style="min-width:160px;">
                                <option value="">Tous les statuts</option>
                                <option value="applied" {{ app.request.query.get('status') == 'applied' ? 'selected' : '' }}>✅ Appliquées</option>
                                <option value="pending" {{ app.request.query.get('status') == 'pending' ? 'selected' : '' }}>⏳ En attente</option>
                            </select>
                        </div>

                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary rounded-pill px-4 shadow-sm"><i class="fas fa-filter mr-1"></i>Filtrer</button>
                            <a id="reset-btn" href="{{ path('app_recommendation') }}" class="btn btn-outline-secondary rounded-pill px-4">Réinitialiser</a>
                        </div>
                    </form>
                </div>
            </div>


            {# Recommendations as Timeline #}
            <div class="card shadow-sm border-0 mb-4" style="border-radius: 20px;">
                <div class="card-header py-3 bg-white d-flex justify-content-between align-items-center" style="border-radius: 20px 20px 0 0;">
                    <h6 class="m-0 font-weight-bold text-primary"><i class="fas fa-stream mr-2"></i>{{ 'recommendations.latest'|trans }}</h6>
                    <span id="results-count" class="badge badge-pill badge-primary-soft text-primary px-3 py-2" style="background: rgba(78, 115, 223, 0.1);">{{ recommendations|length }} résultat(s)</span>
                </div>
                <div class="card-body px-4" id="recommendations-container">
                    {{ include('recommendation/_list.html.twig') }}
                </div>
            </div>
        </div>


        {# ── Chatbot (Moved outside the main col grid but kept in row for structure) ── #}
        <div id="chatbot-wrapper" class="minimized">
            <div class="card shadow border-bottom-primary" style="border-radius: 15px; overflow: hidden;">
                <div class="card-header py-3 bg-gradient-primary d-flex flex-row align-items-center justify-content-between" id="chatbot-toggle" style="cursor:pointer;">
                    <h6 class="m-0 font-weight-bold text-white"><i class="fas fa-robot mr-2"></i>Assistant AuditAI</h6>
                    <div class="chatbot-icons text-white"><i class="fas fa-chevron-up toggle-icon"></i></div>
                </div>
                <div class="card-body d-flex flex-column bg-light" style="height:400px;">
                    <div id="chat-box" class="flex-grow-1 mb-3" style="overflow-y:auto;padding-right:10px;">
                        <div class="d-flex flex-row justify-content-start mb-4">
                            <div class="p-3 bg-white text-gray-900 rounded-lg shadow-sm" style="max-width:85%;border-left:4px solid #4e73df;">
                                <strong>Assistant AuditAI</strong><br>Comment puis-je vous aider aujourd'hui ?
                            </div>
                        </div>
                    </div>
                    <div class="mb-2" id="suggested-questions">
                        <div class="d-flex flex-wrap gap-1">
                            <span class="badge badge-pill badge-white border text-primary p-2 shadow-sm suggested-q" style="cursor:pointer;font-size:.75rem;">Critiques</span>
                            <span class="badge badge-pill badge-white border text-primary p-2 shadow-sm suggested-q" style="cursor:pointer;font-size:.75rem;">Scores faibles</span>
                            <span class="badge badge-pill badge-white border text-success p-2 shadow-sm suggested-q" style="cursor:pointer;font-size:.75rem;">Améliorer</span>
                        </div>
                    </div>
                </div>
                <div class="card-footer bg-white border-0">
                    <div class="input-group bg-light rounded-pill p-1">
                        <input type="text" id="user-input" class="form-control border-0 bg-transparent shadow-none" placeholder="Poser une question...">
                        <div class="input-group-append">
                            <button class="btn btn-primary rounded-circle" type="button" id="send-btn" style="width:35px; height:35px; padding:0;"><i class="fas fa-paper-plane fa-sm"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    {{ include('recommendation/_modal.html.twig', {'reports_list': reports}) }}
</div>
{% endblock %}

{% block javascripts %}
{{ parent() }}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {



    // ── AJAX Filtration ──
    const filterForm = document.getElementById('recommendation-filter-form');
    const container = document.getElementById('recommendations-container');
    const resultsCount = document.getElementById('results-count');

    if (filterForm) {
        const updateFilters = () => {
            const formData = new FormData(filterForm);
            const params = new URLSearchParams(formData);
            
            // Add a loading state
            container.style.opacity = '0.5';
            resultsCount.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Chargement...';
            
            fetch(`${window.location.pathname}?${params.toString()}`, {
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(response => response.text())
            .then(html => {
                container.innerHTML = html;
                container.style.opacity = '1';
                
                // Update results count
                const newCount = container.querySelectorAll('.timeline-item').length;
                resultsCount.innerHTML = `${newCount} résultat(s)`;
                
                // Re-bind toggle events if they were inside the partial
                bindToggleEvents();
            });
        };

        filterForm.querySelectorAll('select').forEach(select => {
            select.addEventListener('change', updateFilters);
        });

        filterForm.addEventListener('submit', (e) => {
            e.preventDefault();
            updateFilters();
        });

        document.getElementById('reset-btn')?.addEventListener('click', (e) => {
            e.preventDefault();
            filterForm.reset();
            updateFilters();
        });
    }

    // Wrap toggle logic in a function to re-bind after AJAX
    function bindToggleEvents() {
        document.querySelectorAll('.applied-btn').forEach(btn => {
            // Remove old listener if any to avoid double triggers
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
            
            newBtn.addEventListener('click', function() {
                const id  = this.dataset.id;
                const url = this.dataset.url;
                const dot = document.querySelector(`#rec-item-${id} .timeline-dot`);
                const card = document.querySelector(`#rec-item-${id} .card`);

                fetch(url, {
                    method: 'POST',
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                })
                .then(r => r.json())
                .then(data => {
                    if (data.isApplied) {
                        this.classList.replace('btn-outline-primary', 'btn-success');
                        this.querySelector('i').className = 'fas fa-check-circle';
                        this.querySelector('span') && (this.querySelector('span').textContent = ' Appliqué');
                        dot && dot.classList.add('applied');
                        card && card.classList.replace('border-left-primary', 'border-left-success');
                    } else {
                        this.classList.replace('btn-success', 'btn-outline-primary');
                        this.querySelector('i').className = 'fas fa-circle';
                        this.querySelector('span') && (this.querySelector('span').textContent = ' À faire');
                        dot && dot.classList.remove('applied');
                        card && card.classList.replace('border-left-success', 'border-left-primary');
                    }
                });
            });
        });
    }

    bindToggleEvents();

    // ── Chatbot ──
    const sendBtn    = document.getElementById('send-btn');
    const userInput  = document.getElementById('user-input');
    const chatBox    = document.getElementById('chat-box');
    const chatbotWrapper = document.getElementById('chatbot-wrapper');
    const chatbotToggle  = document.getElementById('chatbot-toggle');
    const toggleIcon     = document.querySelector('.toggle-icon');

    function appendMessage(text, sender) {
        const div = document.createElement('div');
        div.classList.add('d-flex','flex-row','mb-4');
        const mc = document.createElement('div');
        mc.classList.add('p-3','rounded-lg','shadow-sm');
        mc.style.maxWidth = '85%';
        if (sender === 'bot') {
            let t = text.replace(/\n/g,'<br>').replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/> (.*?)(<br>|$)/g,'<blockquote class="border-left pl-2 text-muted" style="margin-bottom:0">$1</blockquote>');
            mc.innerHTML = t;
            div.classList.add('justify-content-start');
            mc.classList.add('bg-white','text-gray-900');
            mc.style.borderLeft = '4px solid #4e73df';
        } else {
            mc.textContent = text;
            div.classList.add('justify-content-end');
            mc.classList.add('bg-primary','text-white');
        }
        div.appendChild(mc);
        chatBox.appendChild(div);
        setTimeout(() => chatBox.scrollTop = chatBox.scrollHeight, 50);
    }

    async function handleSend(forced = null) {
        const text = forced || userInput.value.trim();
        if (!text) return;
        appendMessage(text, 'user');
        if (!forced) userInput.value = '';
        const lid = 'l-' + Date.now();
        const ld = document.createElement('div');
        ld.id = lid;
        ld.classList.add('d-flex','flex-row','mb-4','justify-content-start');
        ld.innerHTML = '<div class="p-3 bg-gray-200 text-gray-900 rounded-lg shadow-sm"><i class="fas fa-spinner fa-spin mr-2"></i>Analyse...</div>';
        chatBox.appendChild(ld);
        chatBox.scrollTop = chatBox.scrollHeight;
        try {
            const res  = await fetch('/recommendation/ask', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ message: text }) });
            const data = await res.json();
            document.getElementById(lid)?.remove();
            appendMessage(data.response, 'bot');
        } catch(e) {
            document.getElementById(lid)?.remove();
            appendMessage("Erreur de communication avec le serveur.", 'bot');
        }
    }

    sendBtn.addEventListener('click', () => handleSend());
    userInput.addEventListener('keypress', e => { if (e.key === 'Enter') handleSend(); });

    chatbotToggle.addEventListener('click', () => {
        chatbotWrapper.classList.toggle('minimized');
        const min = chatbotWrapper.classList.contains('minimized');
        toggleIcon.classList.toggle('fa-chevron-up', min);
        toggleIcon.classList.toggle('fa-chevron-down', !min);
    });

    document.querySelectorAll('.suggested-q').forEach(b => {
        b.addEventListener('click', function() {
            if (chatbotWrapper.classList.contains('minimized')) {
                chatbotWrapper.classList.remove('minimized');
                toggleIcon.classList.replace('fa-chevron-up','fa-chevron-down');
            }
            handleSend(this.textContent);
        });
    });
});
</script>
{% endblock %}
